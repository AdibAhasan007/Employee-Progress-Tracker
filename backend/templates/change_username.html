{% extends "base.html" %}
{% load static %}

{% block title %}Change Username{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- Page Header -->
            <div class="mb-4">
                <h2 style="color: #333;">
                    <i class="fas fa-user-edit me-2" style="color: #667eea;"></i>Change Username
                </h2>
                <p class="text-muted">Update your account username</p>
                <hr style="border-top: 2px solid #667eea; opacity: 0.5;">
            </div>

            <!-- Success Message -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Error Messages -->
            {% if errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Please fix the following errors:</strong>
                    <ul class="mb-0 mt-2">
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}

            <!-- Username Change Form -->
            <form method="POST" class="needs-validation">
                {% csrf_token %}

                <!-- Current Password Verification -->
                <div class="form-group mb-4">
                    <label for="current_password" class="form-label">
                        <strong>Current Password <span style="color: #ff6b6b;">*</span></strong>
                    </label>
                    <div class="input-group">
                        <input 
                            type="password" 
                            class="form-control" 
                            id="current_password" 
                            name="current_password"
                            placeholder="Enter your password to verify identity"
                            required
                        >
                        <button 
                            class="btn btn-outline-secondary" 
                            type="button" 
                            onclick="togglePasswordVisibility('current_password')"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-lock me-1"></i>
                        We need your password to verify your identity before changing username.
                    </small>
                </div>

                <!-- Current Username Display -->
                <div class="form-group mb-4">
                    <label for="current_username" class="form-label">
                        <strong>Current Username</strong>
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="current_username" 
                        name="current_username"
                        value="{{ user.username }}"
                        readonly
                        style="background-color: #f8f9fa;"
                    >
                </div>

                <!-- New Username -->
                <div class="form-group mb-4">
                    <label for="new_username" class="form-label">
                        <strong>New Username <span style="color: #ff6b6b;">*</span></strong>
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="new_username" 
                        name="new_username"
                        placeholder="Enter your new username"
                        value="{{ new_username }}"
                        minlength="3"
                        maxlength="150"
                        required
                        onkeyup="validateUsername()"
                    >
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        3-150 characters. Letters, numbers, underscore, and hyphen only.
                    </small>
                    <div id="username-validation" class="mt-2"></div>
                </div>

                <!-- Username Format Help -->
                <div class="card bg-light border-secondary mb-4">
                    <div class="card-body">
                        <h6 class="card-title small">
                            <i class="fas fa-check-circle me-2" style="color: #4caf50;"></i>
                            Username Rules
                        </h6>
                        <ul class="small mb-0">
                            <li id="rule-length">
                                <i class="fas fa-circle me-1" style="color: #ccc; font-size: 6px;"></i>
                                Between 3 and 150 characters
                            </li>
                            <li id="rule-format">
                                <i class="fas fa-circle me-1" style="color: #ccc; font-size: 6px;"></i>
                                Only letters, numbers, underscore (_), and hyphen (-)
                            </li>
                            <li id="rule-different">
                                <i class="fas fa-circle me-1" style="color: #ccc; font-size: 6px;"></i>
                                Different from current username
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-end mb-4">
                    <a href="{% url 'admin-account-settings' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(90deg, #667eea, #764ba2); border: none;">
                        <i class="fas fa-check me-2"></i>Change Username
                    </button>
                </div>

                <!-- Security Info -->
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Note:</strong> After changing your username, you'll need to use the new username to login next time.
                </div>
            </form>

            <!-- Account Info -->
            <div class="card bg-light mt-4">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-user-circle me-2" style="color: #667eea;"></i>
                        Account Information
                    </h6>
                    <p class="small mb-1"><strong>Email:</strong> {{ user.email }}</p>
                    <p class="small mb-1"><strong>Role:</strong> <span class="badge bg-info">{{ user.get_role_display }}</span></p>
                    <p class="small mb-0"><strong>Company:</strong> {{ user.company.name }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = event.target.closest('button').querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function validateUsername() {
    const username = document.getElementById('new_username').value;
    const currentUsername = '{{ user.username }}';
    const validationDiv = document.getElementById('username-validation');
    const ruleLength = document.getElementById('rule-length');
    const ruleFormat = document.getElementById('rule-format');
    const ruleDifferent = document.getElementById('rule-different');
    
    let isValid = true;
    let message = '';
    
    // Check length
    if (username.length >= 3 && username.length <= 150) {
        ruleLength.style.color = '#4caf50';
        ruleLength.querySelector('i').style.color = '#4caf50';
    } else if (username.length > 0) {
        isValid = false;
        ruleLength.style.color = '#ff6b6b';
        ruleLength.querySelector('i').style.color = '#ff6b6b';
    } else {
        ruleLength.style.color = '#999';
        ruleLength.querySelector('i').style.color = '#ccc';
    }
    
    // Check format
    const validFormat = /^[a-zA-Z0-9_-]+$/.test(username);
    if (username.length > 0) {
        if (validFormat) {
            ruleFormat.style.color = '#4caf50';
            ruleFormat.querySelector('i').style.color = '#4caf50';
        } else {
            isValid = false;
            message += '<i class="fas fa-exclamation-triangle me-2" style="color: #ff6b6b;"></i>Username contains invalid characters.<br>';
            ruleFormat.style.color = '#ff6b6b';
            ruleFormat.querySelector('i').style.color = '#ff6b6b';
        }
    } else {
        ruleFormat.style.color = '#999';
        ruleFormat.querySelector('i').style.color = '#ccc';
    }
    
    // Check different
    if (username.length > 0) {
        if (username !== currentUsername) {
            ruleDifferent.style.color = '#4caf50';
            ruleDifferent.querySelector('i').style.color = '#4caf50';
        } else {
            isValid = false;
            message += '<i class="fas fa-exclamation-triangle me-2" style="color: #ff6b6b;"></i>Username is same as current username.<br>';
            ruleDifferent.style.color = '#ff6b6b';
            ruleDifferent.querySelector('i').style.color = '#ff6b6b';
        }
    } else {
        ruleDifferent.style.color = '#999';
        ruleDifferent.querySelector('i').style.color = '#ccc';
    }
    
    // Show validation messages
    if (message) {
        validationDiv.innerHTML = '<div class="alert alert-danger small p-2">' + message + '</div>';
    } else {
        validationDiv.innerHTML = '';
    }
}

// Validate on form submit
document.querySelector('form').addEventListener('submit', function(e) {
    const username = document.getElementById('new_username').value;
    
    if (!username || username.length < 3 || username.length > 150) {
        e.preventDefault();
        alert('Username must be between 3 and 150 characters!');
    } else if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
        e.preventDefault();
        alert('Username contains invalid characters!');
    }
});
</script>
{% endblock %}
