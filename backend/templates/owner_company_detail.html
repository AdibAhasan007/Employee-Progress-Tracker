{% extends 'base.html' %}
{% load static %}

{% block title %}{{ company.name }} - OWNER Panel{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>{{ company.name }}</h1>
            <p class="text-muted">{{ company.email }} | Contact: {{ company.contact_person }}</p>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge bg-{{ company.status|lower }} fs-6">{{ company.status }}</span>
            <a href="{% url 'owner-dashboard' %}" class="btn btn-outline-secondary">‚Üê Back</a>
        </div>
    </div>

    <!-- Company Status & Key Info -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Subscription & Plan</h5>
                </div>
                <div class="card-body">
                    <p><strong>Current Plan:</strong> {{ company.plan.name }}</p>
                    <p><strong>Max Employees:</strong> {{ company.plan.max_employees }}</p>
                    <p><strong>Max Storage:</strong> {{ company.plan.max_storage_gb }} GB</p>
                    {% if current_subscription %}
                    <p><strong>Subscription Expires:</strong> {{ current_subscription.expires_at|date:"M d, Y" }}</p>
                    {% endif %}
                    
                    <div class="mt-3">
                        <strong>Change Plan:</strong>
                        <select class="form-select form-select-sm" id="plan-selector">
                            <option value="">Select new plan...</option>
                            {% for plan in available_plans %}
                            <option value="{{ plan.id }}" {% if plan.id == company.plan.id %}selected{% endif %}>
                                {{ plan.name }} ({{ plan.max_employees }} emp, {{ plan.max_storage_gb }}GB)
                            </option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-sm btn-primary mt-2" onclick="changePlan({{ company.id }})">Update Plan</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Company Key & Sync</h5>
                </div>
                <div class="card-body">
                    <p><strong>Company Key:</strong></p>
                    <code class="bg-light p-2 rounded d-block mb-3" id="company-key">{{ company.company_key }}</code>
                    <button class="btn btn-sm btn-warning" onclick="copyToClipboard('{{ company.company_key }}')">Copy Key</button>
                    <button class="btn btn-sm btn-danger" onclick="rotateKey({{ company.id }})">Rotate Key (Security)</button>
                    
                    <p class="mt-3"><strong>Last Sync:</strong></p>
                    {% if company.last_sync_at %}
                    <p>{{ company.last_sync_at|date:"M d, Y H:i" }}</p>
                    {% else %}
                    <p class="text-muted">Never synchronized</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Active Employees</h6>
                    <h3>{{ num_employees }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Work Sessions (90d)</h6>
                    <h3>{{ num_sessions }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Screenshots (90d)</h6>
                    <h3>{{ num_screenshots }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Storage Used</h6>
                    <h3>{{ storage_mb|filesizeformat }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Minutes Chart -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Daily Active Minutes (Last 90 Days)</h5>
        </div>
        <div class="card-body">
            <canvas id="dailyUsageChart" height="80"></canvas>
        </div>
    </div>

    <!-- Company Actions -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
            {% if company.status == 'ACTIVE' %}
            <button class="btn btn-danger" onclick="suspendCompany({{ company.id }})">Suspend Company</button>
            {% elif company.status == 'SUSPENDED' %}
            <button class="btn btn-success" onclick="reactivateCompany({{ company.id }})">Reactivate Company</button>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    alert('Company key copied!');
}

function changePlan(companyId) {
    const planId = document.getElementById('plan-selector').value;
    if (!planId) return;
    
    fetch(`/api/owner/company/${companyId}/change-plan/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `plan_id=${planId}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.status) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function rotateKey(companyId) {
    if (!confirm('Rotate company key? This will disconnect currently syncing desktop apps briefly.')) return;
    
    fetch(`/api/owner/company/${companyId}/rotate-key/`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.status) {
            document.getElementById('company-key').textContent = data.new_key;
            alert('Key rotated! New key:\n\n' + data.new_key);
        }
    });
}

function suspendCompany(companyId) {
    if (!confirm('Suspend this company? Employees will not be able to sync or login.')) return;
    
    fetch(`/api/owner/company/${companyId}/suspend/`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.status) {
            alert(data.message);
            location.reload();
        }
    });
}

function reactivateCompany(companyId) {
    if (!confirm('Reactivate this company?')) return;
    
    fetch(`/api/owner/company/${companyId}/reactivate/`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.status) {
            alert(data.message);
            location.reload();
        }
    });
}

// Daily Usage Chart
const dailyData = {{ daily_usage|safe }};
const labels = [];
const data = [];

dailyData.forEach(day => {
    labels.push(day.date);
    data.push(day.total_active_seconds / 60); // Convert to minutes
});

const ctx = document.getElementById('dailyUsageChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Active Minutes',
            data: data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {display: false}
        },
        scales: {
            y: {beginAtZero: true}
        }
    }
});
</script>
{% endblock %}
